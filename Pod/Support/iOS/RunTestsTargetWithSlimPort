MYPATH=$(dirname $0)
source ${MYPATH}/env.sh
APP_PATH=${TARGET_BUILD_DIR}/${EXECUTABLE_FOLDER_PATH}
DEPLOYMENT_TARGET_VALUE=$( echo "$DEPLOYMENT_TARGET_SUGGESTED_VALUES" | rev | cut -d " " -f1 | rev )
SLIM_PORT=$1
APP_IDENTIFIER=$(/usr/libexec/PlistBuddy $MYPATH/../Info.plist -c "Print CFBundleIdentifier")
DEVICE_TYPE=iPhone

get_app_devicetypeid() {

	local BOOTED_DEVICETYPE_ID=
	local BOOTED_DEVICE_NAME=$(xcrun simctl list devices | grep "Booted" | cut -d "(" -f1 | awk '{gsub(/^ +| +$/,"")} {print $0}')
	
	if [ ! -z "$BOOTED_DEVICE_NAME" ]; then
		BOOTED_DEVICETYPE_ID=$(xcrun simctl list devicetypes | grep "^$BOOTED_DEVICE_NAME (com.apple" | cut -d "(" -f2 | cut -d ")" -f1)
	else
		BOOTED_DEVICETYPE_ID=$(xcrun simctl list devicetypes | grep "$DEVICE_TYPE" | tail -n1 | cut -d "(" -f2 | cut -d ")" -f1)
	fi
	
	echo "$BOOTED_DEVICETYPE_ID, $DEPLOYMENT_TARGET_VALUE"
}

ios_sim_launch() {
	echo "== Begin Slim Test Sytem (ios-sim version $($MYPATH/ios-sim --version)) =="
	$MYPATH/ios-sim launch $1 --exit --devicetypeid "$2" --args $3 
}

run_test_system() {
	local DEVICE_TYPE_IDENTIFIER=$(get_app_devicetypeid)
	echo "Slim Test System Bundle Identifier: $APP_IDENTIFIER"
	echo "Slim Test System SDK Deployment Target: $DEPLOYMENT_TARGET_VALUE"
	echo "Slim Test System Executable Folder Path: $APP_PATH"
	echo "Simulator Device Identifier: $DEVICE_TYPE_IDENTIFIER"
	ios_sim_launch $APP_PATH "$DEVICE_TYPE_IDENTIFIER" $SLIM_PORT
}

main() {
	echo "== OCSlimProject:RunSlimTestTargetWithSlimPort:$SLIM_PORT =="
	run_test_system
	exit
}

main


